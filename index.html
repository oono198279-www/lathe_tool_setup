<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>手研ぎバイト取付計算</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="theme-color" content="#f5f5f5">

  <!-- PWA 用 -->
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    body{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 1rem;
      background:#f5f5f5;
    }
    h1{
      font-size:1.4rem;
      margin:0 0 .8rem;
    }

    /* テーブル＋画像の横並び */
    .layout{
      display:flex;
      flex-wrap:nowrap;
      gap:.75rem;
      align-items:flex-start;
    }

    .table-wrap{
      background:#fff;
      padding:.5rem;
      border-radius:.5rem;
      box-shadow:0 0 4px rgba(0,0,0,.08);
      flex:0 0 auto;
    }

    table{
      border-collapse:collapse;
      font-size:0.95rem;
    }
    th,td{
      border:1px solid #ccc;
      padding:.3rem .4rem;
      text-align:center;
      min-width:3.8rem;
    }
    th.label{
      background:#e0e0e0;
      width:2.5rem;
    }
    td.value{
      background:#fff9c4;
    }
    td.value input{
      width:6ch;
      font-size:0.95rem;
      border:none;
      background:transparent;
      text-align:right;
    }
    td.calc{
      background:#fff;
      font-weight:bold;
    }
    .unit{
      font-size:.8rem;
      color:#555;
    }

    .img-wrap{
      background:#fff;
      padding:.5rem;
      border-radius:.5rem;
      box-shadow:0 0 4px rgba(0,0,0,.08);
      flex:0 0 130px;
      max-width:130px;
    }
    .img-wrap img{
      width:100%;
      height:auto;
      display:block;
    }

    .steps{
      background:#fff;
      padding:.8rem;
      border-radius:.5rem;
      box-shadow:0 0 4px rgba(0,0,0,.08);
      margin-top:1rem;
      font-size:0.95rem;
      line-height:1.4;
    }
    .steps p{
      margin:.2rem 0;
    }

    .code{
      font-family: "SF Mono", Menlo, Consolas, monospace;
      background:#111;
      color:#0f0;
      padding:.6rem .8rem;
      border-radius:.3rem;
      margin:.4rem 0;
      white-space:pre;
    }

    .actions{
      margin-top:.8rem;
      display:flex;
      flex-wrap:wrap;
      gap:.5rem;
    }
    .actions button{
      padding:.4rem .8rem;
      font-size:.9rem;
      border-radius:.3rem;
      border:1px solid #888;
      background:#f0f0f0;
    }
    .actions button:active{
      background:#e0e0e0;
    }

    @media (max-width:360px){
      .layout{
        flex-wrap:wrap;
      }
      .img-wrap{
        flex:1 1 100%;
        max-width:none;
      }
    }
  </style>
</head>
<body>
<h1>手研ぎバイト取付用計算シート</h1>

<div class="layout">
  <!-- テーブル -->
  <div class="table-wrap">
    <table>
      <tr>
        <th class="label">@</th>
        <td class="value">
          <input id="at" type="number" step="0.001" value="0.000">
          <span class="unit">mm</span>
        </td>
      </tr>
      <tr>
        <th class="label">W</th>
        <td class="value">
          <input id="w" type="number" step="0.001" value="0.000">
          <span class="unit">mm</span>
        </td>
      </tr>
      <tr>
        <th class="label">芯高</th>
        <td class="value">
          <input id="center" type="number" step="0.001" value="0.000">
          <span class="unit">mm</span>
        </td>
      </tr>
      <tr>
        <th class="label">鋼材径</th>
        <td class="value">
          <input id="dia" type="number" step="0.001" value="3.000">
          <span class="unit">mm</span>
        </td>
      </tr>
      <tr>
        <th class="label">X</th>
        <td class="calc" id="xCell">4.000</td>
      </tr>
    </table>
    <p style="font-size:.8rem;margin-top:.3rem;">
      ※X = (@ × 2) + 鋼材径
    </p>
  </div>

  <!-- 刃物画像（blade.png を同じフォルダに置く）-->
  <div class="img-wrap">
    <img src="blade.png" alt="刃物図">
  </div>
</div>

<div class="steps">
  <p id="step1">① 使用済み刃具をアンクランプし取り出します</p>
  <p id="step2">② X軸の補正値を 0.000 に合わせます</p>
  <p id="step3">③ Z軸の補正値を 0.000 に合わせます</p>
  <p id="step4">④ 芯高の補正値を 0.000 に合わせます</p>
  <p id="step5">⑤ JOG操作でメインチャックを把握します</p>
  <p id="step6">⑥ MDI操作で以下のプログラムを実行します</p>
  <div class="code" id="gcode">
G0 X38.0;
T0000;
X3.000 Z10.0;
  </div>
  <p id="step7">⑦ 刃具の端面を鋼材に当てた状態でクランプします</p>

  <p id="step8">⑧ MDI操作で以下のプログラムを実行します</p>
  <div class="code" id="gcode8">
X38.0;
T0000;
G99 M3 S2000;
X4.0;
  </div>

  <p id="step9">⑨ クーラントを ON にします（パネルのクーラントONボタン）</p>

  <p id="step10">⑩ MDI操作で以下のプログラムを実行します</p>
  <div class="code">
G1 X-1.0 F0.02;
M5;
M11;
  </div>

  <div class="actions">
    <button type="button" id="exportBtn">JSONで保存</button>
    <button type="button" id="importBtn">JSONから復元</button>
    <input type="file" id="jsonFile" accept="application/json" style="display:none">
  </div>
</div>

<script>
const STORAGE_KEY = 'lathe_tool_setup_v1';

// ⑥・⑧ の T 番（デフォルト）
let tool6 = 'T0000';
let tool8 = 'T0000';

function fmt(v){
  if (Number.isNaN(v)) return "";
  return v.toFixed(3);
}

function getInputs(){
  return {
    at:     document.getElementById("at").value,
    w:      document.getElementById("w").value,
    center: document.getElementById("center").value,
    dia:    document.getElementById("dia").value,
    tool6:  tool6,
    tool8:  tool8
  };
}

// JSON から読み込んだ値を反映
function applyInputs(data){
  if(data.at      != null) document.getElementById("at").value     = data.at;
  if(data.w       != null) document.getElementById("w").value      = data.w;
  if(data.center  != null) document.getElementById("center").value = data.center;
  if(data.dia     != null) document.getElementById("dia").value    = data.dia;

  // T 番は "T" + 数字4桁 の時だけ採用
  if (typeof data.tool6 === "string" && /^T\d{4}$/.test(data.tool6)) {
    tool6 = data.tool6;
  }
  if (typeof data.tool8 === "string" && /^T\d{4}$/.test(data.tool8)) {
    tool8 = data.tool8;
  }
}

function update(){
  const at   = parseFloat(document.getElementById("at").value) || 0;
  const w    = parseFloat(document.getElementById("w").value) || 0;
  const cen  = parseFloat(document.getElementById("center").value) || 0;
  const dia  = parseFloat(document.getElementById("dia").value) || 0;

  const x = (at * 2) + dia;
  const xApproach = Math.ceil(dia + 1); // 材料径+1 を小数切り上げ

  // メインX表示
  document.getElementById("xCell").textContent = fmt(x);

  // 手順の数値反映
  document.getElementById("step3").textContent =
    "③ Z軸の補正値を " + fmt(w) + " に合わせます";

  document.getElementById("step4").textContent =
    "④ 芯高の補正値を " + fmt(cen) + " に合わせます";

  // ⑥ のGコード
  const gcode =
`G0 X38.0;
${tool6};
X${fmt(x)} Z10.0;`;
  document.getElementById("gcode").textContent = gcode;

  // ⑧ のGコード（材料径から計算）
  const gcode2 =
`X38.0;
${tool8};
G99 M3 S2000;
X${xApproach}.0;`;
  document.getElementById("gcode8").textContent = gcode2;
}

function saveState(){
  try{
    const data = getInputs();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }catch(e){
    console.log('saveState error:', e);
  }
}

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    const data = JSON.parse(raw);
    applyInputs(data);
  }catch(e){
    console.log('loadState error:', e);
  }
}

// JSONとしてダウンロード
function exportJson(){
  try{
    const data = getInputs();
    const json = JSON.stringify(data, null, 2);
    const blob = new Blob([json], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "手研ぎバイト取付計算ツール_backup.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }catch(e){
    console.log('exportJson error:', e);
    alert("JSONの保存に失敗しました。");
  }
}

// JSONファイルから復元
function importJsonFile(file){
  const reader = new FileReader();
  reader.onload = (e) => {
    try{
      const text = e.target.result;
      const data = JSON.parse(text);
      if(typeof data !== 'object' || data === null){
        throw new Error("invalid");
      }
      applyInputs(data);
      saveState();
      update();
      alert("JSONから復元しました。");
    }catch(err){
      console.log('importJson error:', err);
      alert("JSONの読み込みに失敗しました。");
    }
  };
  reader.readAsText(file);
}

// 入力イベント：更新＋保存
document.querySelectorAll("input").forEach(el=>{
  el.addEventListener("input", () => {
    update();
    saveState();
  });
});

// ボタンのイベント
document.getElementById("exportBtn").addEventListener("click", exportJson);

document.getElementById("importBtn").addEventListener("click", () => {
  document.getElementById("jsonFile").click();
});

document.getElementById("jsonFile").addEventListener("change", (e) => {
  const file = e.target.files[0];
  if(!file){
    e.target.value = "";
    return;
  }
  importJsonFile(file);
  // 同じファイルをもう一度選べるようにクリア
  e.target.value = "";
});

// 起動時：保存値を読み込み → 計算反映
loadState();
update();

// ▼ Service Worker 登録（PWA 用）
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(err => {
      console.log('SW registration failed:', err);
    });
  });
}
</script>
</body>
</html>